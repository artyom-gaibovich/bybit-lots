<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">

</head>
<body>

<div id="root">

</div>


<script>
    /**
     * [
     *             {
     *                 id: 1,
     *                 name: 'CRYPUSDT',
     *                 description: 'CRYPTOUSDT Desc',
     *                 price: 16
     *             },
     *             {
     *                 id: 2,
     *                 name: 'TRAMPUSDT',
     *                 description: 'TRAMPUSDT Desc',
     *                 price: 32
     *             }
     *         ]
     */


    const apiClient = () => {
        const get = (url) => {
            return new Promise((resolve, reject) => {
                setTimeout(() => resolve([
                    {id: 1, name: 'TRAMUSDT', description: 'Software Developer', price: 32},
                    {id: 2, name: 'GRASSUSDT', description: 'Software Developer 3', price: 32},
                    {id: 3, name: 'TREEUSDT', description: 'Software Developer 2', price: 32},
                ]), 2000)
            })
        }
        return {
            get,
        }
    }

    let state = {
        time: new Date(),
        lots: null
    }


    function Loader() {
        const node = document.createElement('div')
        node.className = 'loading'
        node.innerText = 'Loading...'
        return node;
    }

    function Logo() {
        const logo = document.createElement('img');
        logo.classList.add('logo');
        logo.src = 'logo.png';
        return logo;
    }

    function Header() {
        const header = document.createElement('header');
        header.classList.add('header');
        header.append(Logo())
        return header;
    }

    function Clock({time}) {

        const node = document.createElement('div')
        node.classList.add('clock')

        const value = document.createElement('span')
        value.classList.add('value')
        value.innerText = time.toLocaleString()

        node.append(value)

        const icon = document.createElement('span')
        if (time.getHours() >= 7 && time.getHours() < 21) {
            icon.classList.add('icon', 'day')
        } else {
            icon.classList.add('icon', 'night')

        }
        icon.innerText = '()'
        node.append(icon)
        return node;
    }

    function Lot({price, name, description}) {
        const lot = document.createElement('article')
        lot.classList.add('lot');
        const priceEl = document.createElement('div');
        priceEl.innerText = price;
        const h1 = document.createElement('h1');
        h1.innerText = name
        const p = document.createElement('p');
        p.innerText = description;
        lot.append(h1, priceEl, p)
        return lot;
    }

    function Lots({lots}) {
        if (lots === null) {
            return Loader()
        }

        const list = document.createElement('lots')
        list.classList.add('lots');
        lots.forEach((lot) => {
            list.append(Lot(lot))
        })
        return list;
    }

    function App({state}) {
        const app = document.createElement('app');
        app.classList.add('app');
        app.append(Header(), Clock({time: state.time}), Lots({lots: state.lots}));
        return app;
    }

    renderView(state)

    setInterval(() => {
        state = {
            ...state,
            time: new Date(),
        }
        renderView(state)

    }, 1000)



    const stream = {
        subscribe (channel, listener) {
            const match = /price-(\d+)/.exec(channel)
            if (match) {
                setInterval( () => {
                    listener({
                        id: parseInt(match[1]),
                        price: Math.round((Math.random() * 10 + 30))
                    })
                }, 400)
            }
        }
    }


    const api = apiClient()

    api.get('/api').then((lots) => {
        state = {
            ...state,
            lots,
        }
        renderView(state)



        const onPrice = (data) => {
            state = {
                ...state,
                lots: state.lots.map((lot => {
                    if (lot.id === data.id) {
                        return {
                            ...lot,
                            price: data.price
                        }
                    }
                    return lot
                }))
            }
            renderView(state)
        }

        lots.forEach((lot) => {
            stream.subscribe(`price-${lot.id}`, onPrice)
        })
    })

    function renderView(state) {
        render(
            App({state}), document.getElementById('root')
        )
    }

    function render(newDom, realDomRoot) {
        realDomRoot.innerHTML = '';
        realDomRoot.append(newDom)
    }


</script>
</body>
</html>